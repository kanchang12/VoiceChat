<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
</head>
<body>
    <h1>AI Assistant</h1>
    
    <!-- Button to start the conversation -->
    <button id="startButton" onclick="startConversation()">Start Conversation</button>

    <!-- Button to stop the AI from speaking -->
    <button id="stopButton" onclick="stopAudio()" disabled>Stop Speaking</button>

    <script>
        let audio; // Variable to hold the audio object

        // Function to stop the audio
        function stopAudio() {
            if (audio) {
                audio.pause();  // Pause the audio
                audio.currentTime = 0;  // Optionally reset the audio to the start
                console.log("AI speech stopped.");
                document.getElementById('stopButton').disabled = true; // Disable stop button after stopping
            }
        }

        let checkingSpeech = false;
let sessionId = 'default';

function startConversation() {
    fetch(`/start_conversation?session_id=${sessionId}`)
        .then(response => response.json())
        .then(data => {
            displayMessage('bot', data.text);
            playAudio(data.audio);
            startCheckingSpeech();
        });
}

function startCheckingSpeech() {
    checkingSpeech = true;
    checkSpeech();
}

function checkSpeech() {
    if (!checkingSpeech) return;
    
    fetch(`/check_speech?session_id=${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'response') {
                // Display user's speech and bot's response
                displayMessage('user', data.user_text);
                displayMessage('bot', data.bot_text);
                playAudio(data.audio);
            }
            // Continue checking if still active
            if (checkingSpeech) {
                setTimeout(checkSpeech, 500); // Poll every 500ms
            }
        });
}

function stopConversation() {
    checkingSpeech = false;
    fetch('/stop_conversation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ session_id: sessionId })
    });
}

function playAudio(base64Audio) {
    const audio = new Audio(`data:audio/mp3;base64,${base64Audio}`);
    audio.play();
}

function displayMessage(sender, text) {
    // Implement your message display logic here
    const messagesDiv = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${sender}`;
    messageElement.textContent = text;
    messagesDiv.appendChild(messageElement);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

        // Function to start the conversation
        function startConversation() {
            // Disable the start button once clicked to prevent multiple clicks
            document.getElementById('startButton').disabled = true;

            // Enable the stop button once the conversation starts
            document.getElementById('stopButton').disabled = false;

            // Fetch the first response (greeting message)
            fetch('/start_conversation')
                .then(response => response.json())
                .then(data => {
                    // Create an audio object from the base64 data
                    audio = new Audio('data:audio/mp3;base64,' + data.audio);

                    // Play the audio response from AI
                    audio.play()
                        .then(() => console.log('AI is speaking...'))
                        .catch(error => console.error('Error playing audio:', error));

                    // Optionally, log the text response
                    console.log('AI Response:', data.text);
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
